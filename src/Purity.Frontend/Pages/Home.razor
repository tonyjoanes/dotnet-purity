@page "/"
@inject HttpClient Http
@inject ILogger<Home> Logger
@using System.ComponentModel.DataAnnotations

<PageTitle>Purity Dashboard</PageTitle>

@* TODO: Re-enable AuthorizeView once GitHub token validation is implemented (Option B) *@
<div class="container py-4">
    <h1 class="mb-4">Run Purity analyzers</h1>
    <div class="mb-3">
        <label class="form-label" for="repositoryPath">Repository path</label>
        <input type="text" 
               id="repositoryPath"
               class="form-control"
               @bind="_request.RepositoryPath"
               @bind:event="oninput" />
        <div class="form-text">
            Provide the absolute path to the repository on the API server.
        </div>
    </div>

    <button class="btn btn-primary" type="button" @onclick="RunScanAsync" disabled="@IsButtonDisabled">
        @_buttonLabel
    </button>

    @if (_isRunning)
    {
        <div class="alert alert-info mt-4" role="status">
            <span class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
            Running analyzers...
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <div class="alert alert-danger mt-4" role="alert">
            @_error
        </div>
    }

    @if (_response is not null)
    {
        <div class="mt-4">
            <h2 class="h4">Diagnostics (@_response.Diagnostics.Count)</h2>

            @if (_response.Diagnostics.Count == 0)
            {
                <p class="text-success">No purity diagnostics reported.</p>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Id</th>
                                <th scope="col">Message</th>
                                <th scope="col">Severity</th>
                                <th scope="col">File</th>
                                <th scope="col">Span</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var diagnostic in _response.Diagnostics)
                            {
                                <tr>
                                    <td>@diagnostic.Id</td>
                                    <td>@diagnostic.Message</td>
                                    <td>@diagnostic.Severity</td>
                                    <td>@diagnostic.FilePath</td>
                                    <td>@FormatSpan(diagnostic.Location)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    }
</div>

@code {
    private readonly ScanRequestModel _request = new();
    private ScanResponse? _response;
    private string? _error;
    private bool _isRunning;

    private string _buttonLabel => _isRunning ? "Running..." : "Run scan";
    
    private bool IsButtonDisabled => _isRunning || string.IsNullOrWhiteSpace(_request.RepositoryPath);

    private async Task RunScanAsync()
    {
        if (string.IsNullOrWhiteSpace(_request.RepositoryPath))
        {
            _error = "Please enter a repository path.";
            return;
        }

        _isRunning = true;
        _error = null;
        _response = null;

        try
        {
            var httpResponse = await Http.PostAsJsonAsync("scan", new { repositoryPath = _request.RepositoryPath });

            if (httpResponse.IsSuccessStatusCode)
            {
                _response = await httpResponse.Content.ReadFromJsonAsync<ScanResponse>();
            }
            else
            {
                var problem = await httpResponse.Content.ReadFromJsonAsync<ProblemResponse>();
                _error = problem?.Detail ?? "Analyzer run failed.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to run purity analyzers");
            _error = ex.Message;
        }
        finally
        {
            _isRunning = false;
        }
    }

    private static string FormatSpan(AnalyzerLocation location) =>
        $"{location.StartLine}:{location.StartColumn} - {location.EndLine}:{location.EndColumn}";

    private sealed class ScanRequestModel
    {
        [Required(ErrorMessage = "Repository path is required.")]
        public string RepositoryPath { get; set; } = string.Empty;
    }

    private sealed record ProblemResponse(string? Title, string? Detail);

    private sealed record ScanResponse(List<AnalyzerDiagnostic> Diagnostics);

    private sealed record AnalyzerDiagnostic(
        string Id,
        string Title,
        string Message,
        string Severity,
        string FilePath,
        AnalyzerLocation Location);

    private sealed record AnalyzerLocation(int StartLine, int StartColumn, int EndLine, int EndColumn);
}
